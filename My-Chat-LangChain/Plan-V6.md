# My-Chat-LangChain V6: æ·±åº¦å›é¡¾ä¸ä¸‹ä¸€ä»£æ¶æ„è®¾è®¡æ–¹æ¡ˆ

## 1. V5 ç‰ˆæœ¬æ·±åº¦å›é¡¾ (Deep Review & Reflection)

åœ¨ V5 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº†ä»â€œè¢«åŠ¨é—®ç­”â€åˆ°â€œä¸»åŠ¨ Agentâ€çš„è·¨è¶Šã€‚å¼•å…¥ LangGraph å’Œ MCP åè®®è®©ç³»ç»Ÿå…·å¤‡äº†æ„ŸçŸ¥ä¸–ç•Œï¼ˆæœç´¢ã€çˆ¬è™«ï¼‰å’Œä½¿ç”¨å·¥å…·çš„èƒ½åŠ›ã€‚

### âœ… äº®ç‚¹ (Strengths)
1.  **æ¶æ„å…ˆè¿›æ€§**: é‡‡ç”¨äº† LangGraph (ReAct) å’Œ MCP (Model Context Protocol) çš„å‰æ²¿ç»„åˆï¼Œå…·å¤‡æé«˜çš„æ‰©å±•æ€§ã€‚
2.  **åŠŸèƒ½é—­ç¯**: å®ç°äº†â€œæ„å›¾è¯†åˆ« -> å·¥å…·è°ƒç”¨ -> ä¿¡æ¯è·å– -> ç»“æ„åŒ–è¾“å‡ºâ€çš„å®Œæ•´ä¸šåŠ¡é—­ç¯ã€‚
3.  **å¤šæ¨¡æ€é›å½¢**: å‰ç«¯èƒ½å¤Ÿæ¸²æŸ“ç»“æ„åŒ–å¡ç‰‡ï¼ˆè®ºæ–‡ã€ç®€å†ï¼‰ï¼Œè¶…è¶Šäº†çº¯æ–‡æœ¬å¯¹è¯ã€‚
4.  **é…ç½®çµæ´»**: æ”¯æŒå‰ç«¯åŠ¨æ€é…ç½® API Keyï¼Œé™ä½äº†éƒ¨ç½²é—¨æ§›ã€‚

### âš ï¸ ç—›ç‚¹ä¸ä¸è¶³ (Weaknesses & Bottlenecks)
ç»è¿‡ä»£ç å®¡è®¡å’Œè¿è¡Œåˆ†æï¼Œå‘ç°å½“å‰æ¶æ„å­˜åœ¨ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯ V6 å¿…é¡»è§£å†³çš„é‡ç‚¹ï¼š

1.  **äº¤äº’å‰²è£‚ (Fragmented UX)**:
    *   **ç°çŠ¶**: åŠŸèƒ½è¢«æ‹†åˆ†ä¸º "Universal Agent", "Web RAG", "Doc RAG" ä¸‰ä¸ªç‹¬ç«‹çš„æ ‡ç­¾é¡µã€‚
    *   **é—®é¢˜**: ç”¨æˆ·ä½“éªŒä¸è¿è´¯ã€‚ç”¨æˆ·æ— æ³•åœ¨ä¸€ä¸ªå¯¹è¯ä¸­åŒæ—¶å¼•ç”¨ç½‘é¡µå’ŒPDFï¼Œä¹Ÿæ— æ³•è®© Agent è‡ªåŠ¨å†³å®šæ˜¯æœç´¢è¿˜æ˜¯æŸ¥æ–‡æ¡£ã€‚
    *   **æ”¹è¿›**: **ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µï¼Œç»Ÿä¸€ä¸ºå•ä¸€çš„ Chat Interface**ã€‚æ–‡ä»¶ä¸Šä¼ å’Œ URL å­¦ä¹ å…¨éƒ¨ä½œä¸º Agent çš„å·¥å…·ï¼ˆToolsï¼‰æˆ–èƒ½åŠ›ï¼Œç”± Agent ç»Ÿä¸€è°ƒåº¦ã€‚

2.  **RAG å­˜å‚¨ç¢ç‰‡åŒ– (Storage Fragmentation)**:
    *   **ç°çŠ¶**: å¯¹æ¯ä¸ª URL æˆ–æ–‡ä»¶ï¼Œç³»ç»Ÿéƒ½ä¼šåœ¨ç£ç›˜ä¸Šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ `chroma_db_md5...` æ–‡ä»¶å¤¹ã€‚
    *   **é—®é¢˜**: å½“ç”¨æˆ·æµè§ˆæ•°ç™¾ä¸ªç½‘é¡µæ—¶ï¼Œä¼šäº§ç”Ÿæµ·é‡å°æ–‡ä»¶å¤¹ï¼Œå¯¼è‡´æ–‡ä»¶ç³»ç»Ÿ I/O å‹åŠ›å¤§ï¼Œä¸”æ— æ³•è¿›è¡Œè·¨æ–‡æ¡£çš„ç»¼åˆæ£€ç´¢ï¼ˆGlobal Searchï¼‰ã€‚
    *   **æ”¹è¿›**: å¿…é¡»è¿ç§»åˆ° **å•ä¸€å‘é‡æ•°æ®åº“å®ä¾‹ + Collection/Metadata è¿‡æ»¤** çš„æ¨¡å¼ã€‚

3.  **ç¼ºä¹æµå¼å“åº” (Lack of Streaming)**:
    *   **ç°çŠ¶**: ç”¨æˆ·æé—®åï¼Œå¿…é¡»ç­‰å¾… Agent å®Œæˆæ‰€æœ‰æ€è€ƒæ­¥éª¤ï¼ˆæœç´¢ã€é˜…è¯»ã€æ€»ç»“ï¼‰åï¼Œæ‰èƒ½ä¸€æ¬¡æ€§çœ‹åˆ°ç»“æœã€‚
    *   **é—®é¢˜**: å¤æ‚ä»»åŠ¡å¯èƒ½è€—æ—¶ 30ç§’+ï¼Œæ­¤æ—¶ç•Œé¢å‘ˆâ€œå‡æ­»â€çŠ¶æ€ï¼Œç”¨æˆ·ä½“éªŒæå·®ã€‚
    *   **æ”¹è¿›**: å®ç° **End-to-End Streaming**ã€‚å‰ç«¯åº”å®æ—¶å±•ç¤º Agent çš„â€œæ€è€ƒè¿‡ç¨‹â€ï¼ˆå¦‚ï¼šæ­£åœ¨æœç´¢... æ­£åœ¨é˜…è¯»...ï¼‰ï¼Œå¹¶é€å­—è¾“å‡ºæœ€ç»ˆç­”æ¡ˆã€‚

3.  **çŠ¶æ€æ˜“å¤±æ€§ (Ephemeral State)**:
    *   **ç°çŠ¶**: ä½¿ç”¨ `InMemorySaver`ï¼Œä¸” `thread_id` å¤„ç†è¾ƒä¸ºç®€å•ã€‚
    *   **é—®é¢˜**: é‡å¯åç«¯æœåŠ¡åï¼Œæ‰€æœ‰çš„å¯¹è¯è®°å¿†ï¼ˆShort-term Memoryï¼‰éƒ½ä¼šä¸¢å¤±ã€‚æ— æ³•æ”¯æŒå¤šç”¨æˆ·ã€å¤šä¼šè¯çš„å†å²è®°å½•å›æº¯ã€‚
    *   **æ”¹è¿›**: å¼•å…¥ **SQLite/PostgreSQL æŒä¹…åŒ–å±‚**ï¼Œä¿å­˜å¯¹è¯å†å²å’Œ Agent Checkpointsã€‚

4.  **å·¥å…·æ³›åŒ–èƒ½åŠ›ä¸è¶³ (Over-Specialized Tools)**:
    *   **ç°çŠ¶**: `generate_search_queries` å·¥å…·çš„ Prompt ä¸¥é‡å€¾å‘äºâ€œAI çŒå¤´/è®ºæ–‡ç ”ç©¶â€åœºæ™¯ã€‚
    *   **é—®é¢˜**: å¦‚æœç”¨æˆ·é—®â€œå¦‚ä½•åšçº¢çƒ§è‚‰â€æˆ–â€œ2024 å¥¥è¿ä¼šé‡‘ç‰Œæ¦œâ€ï¼ŒAgent å¯èƒ½ä¼šç”Ÿæˆéå¸¸å¥‡æ€ªçš„â€œå­¦æœ¯/çŒå¤´é£æ ¼â€æœç´¢è¯ã€‚
    *   **æ”¹è¿›**: é‡æ„æœç´¢å·¥å…·ï¼Œä½¿å…¶å…·å¤‡ **é€šç”¨æ„å›¾ç†è§£** èƒ½åŠ›ï¼Œæˆ–æ ¹æ®ç”¨æˆ· Query åŠ¨æ€é€‰æ‹© Personaã€‚

---

## 2. V6 æ¶æ„è®¾è®¡ç›®æ ‡ (Design Objectives)

**ä»£å·**: `Stream-Agent` (æµå¼æ™ºèƒ½ä½“å¹³å°)
**æ ¸å¿ƒç†å¿µ**: **å®æ—¶ (Real-time)ã€æŒä¹… (Persistent)ã€ç»Ÿä¸€ (Unified)**

### æ ¸å¿ƒæ”¹è¿›ç‚¹
1.  **å•çª—å£äº¤äº’ (One Window to Rule Them All)**: å½»åº•ç§»é™¤ Tab åˆ†é¡µã€‚Agent æ˜¯å”¯ä¸€çš„å…¥å£ï¼Œæ–‡ä»¶ä¸Šä¼ å’Œ URL åˆ†æåªæ˜¯ Agent æ‰‹ä¸­çš„å·¥å…·ã€‚
2.  **å…¨é“¾è·¯æµå¼ (Streaming First)**: ä» LLM åˆ° Frontendï¼Œå…¨é¢æ”¯æŒ SSE (Server-Sent Events) æˆ–æµå¼ä¼ è¾“ï¼Œå±•ç¤ºä¸­é—´æ€ç»´é“¾ã€‚
3.  **ç»Ÿä¸€çŸ¥è¯†åº“ (Unified Knowledge Base)**: å•ä¸€ ChromaDB å®ä¾‹ï¼Œæ‰€æœ‰æ¥æºï¼ˆURLã€PDFã€Uploadsï¼‰ç»Ÿä¸€å­˜å‚¨ï¼Œé€šè¿‡ Metadata è¿›è¡ŒæºåŒºåˆ†ã€‚
4.  **ä¼šè¯æŒä¹…åŒ– (Session Persistence)**: åŸºäº SQLite çš„å¯¹è¯ç®¡ç†ï¼Œæ”¯æŒä¾§è¾¹æ å†å²è®°å½•åˆ‡æ¢ã€‚

---

## 3. V6 è¯¦ç»†æ”¹è¿›æ–¹æ¡ˆ (Improvement Plan)

### 3.1 æ•°æ®åº“ä¸å­˜å‚¨é‡æ„ (Database & Storage)

*   **Vector Store**:
    *   å¼ƒç”¨: `create_vector_store_from_url` åˆ›å»ºæ–°ç›®å½•çš„é€»è¾‘ã€‚
    *   é‡‡ç”¨: å…¨å±€å•ä¾‹ `Chroma` å®¢æˆ·ç«¯ã€‚
    *   é€»è¾‘: æ‘„å–æ–° URL æ—¶ï¼Œå­˜å…¥åŒä¸€ä¸ª Collectionï¼Œå¹¶åœ¨ Metadata ä¸­æ ‡è®° `source: url`ã€‚æŸ¥è¯¢æ—¶ä½¿ç”¨ `filter={"source": url}`ã€‚è‹¥éœ€è·¨æ–‡æ¡£æŸ¥è¯¢ï¼Œåˆ™ç§»é™¤ Filterã€‚
*   **State Store**:
    *   å¼ƒç”¨: `InMemorySaver`ã€‚
    *   é‡‡ç”¨: `langgraph.checkpoint.sqlite.SqliteSaver`ã€‚
    *   æ–°å¢: `chat_history.db` (SQLite) ç”¨äºå­˜å‚¨ Session åˆ—è¡¨å’Œæ¶ˆæ¯è®°å½•ã€‚

### 3.2 åç«¯ API å‡çº§ (Backend API Upgrade)

*   **Streaming Endpoint**:
    *   æ–°å¢ `/chat/stream` æ¥å£ã€‚
    *   æŠ€æœ¯: ä½¿ç”¨ `StreamingResponse` (FastAPI) é…åˆ LangGraph çš„ `.astream_events()`ã€‚
    *   åè®®: å®šä¹‰è‡ªå®šä¹‰ SSE äº‹ä»¶æµï¼Œä¾‹å¦‚:
        *   `event: agent_thought` (æ•°æ®: "æ­£åœ¨æ€è€ƒæœç´¢å…³é”®è¯...")
        *   `event: tool_start` (æ•°æ®: "è°ƒç”¨å·¥å…·: Google Search")
        *   `event: tool_end` (æ•°æ®: "æœç´¢å®Œæˆï¼Œæ‰¾åˆ° 5 æ¡ç»“æœ")
        *   `event: text_chunk` (æ•°æ®: "æ ¹æ®...")
        *   `event: done`

### 3.3 æ™ºèƒ½ä½“èƒ½åŠ›å‡çº§ (Agent Upgrade)

*   **RAG å·¥å…·åŒ– (RAG as Tools)**:
    *   **`ingest_knowledge(source: str, type: str)`**: ç»Ÿä¸€çš„çŸ¥è¯†æ‘„å–å·¥å…·ã€‚
        *   å¦‚æœ `type='url'`: çˆ¬å–ç½‘é¡µ -> å­˜å…¥å‘é‡åº“ã€‚
        *   å¦‚æœ `type='file'`: è¯»å–ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ -> å­˜å…¥å‘é‡åº“ã€‚
    *   **`query_knowledge_base(query: str, source_filter: Optional[str])`**: ç»Ÿä¸€çš„æŸ¥è¯¢å·¥å…·ã€‚
        *   Agent å¯æ ¹æ®ä¸Šä¸‹æ–‡å†³å®šæ˜¯æŸ¥å…¨åº“ï¼Œè¿˜æ˜¯åªæŸ¥ç‰¹å®šçš„ URL/æ–‡ä»¶ã€‚
*   **äº¤äº’æµç¨‹å˜é©**:
    *   ç”¨æˆ·åœ¨å‰ç«¯ä¸Šä¼  PDF -> å‰ç«¯ä¿å­˜æ–‡ä»¶å¹¶å‘é€ç³»ç»Ÿæ¶ˆæ¯ "User uploaded file: report.pdf" -> Agent è§¦å‘ `ingest_knowledge('report.pdf', 'file')` -> Agent ç­”å¤ "å·²å­¦ä¹ æ–‡ä»¶ report.pdfï¼Œè¯·é—®æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"ã€‚
*   **é€šç”¨åŒ– Prompt**: ä¿®æ”¹ `generate_search_queries`ï¼Œç§»é™¤ç¡¬ç¼–ç çš„â€œAI ä¸“å®¶â€äººè®¾ï¼Œæ”¹ä¸ºâ€œæ ¹æ®ç”¨æˆ·é—®é¢˜åŠ¨æ€åˆ†ææœç´¢æ„å›¾â€ã€‚

### 3.4 å‰ç«¯ä½“éªŒå‡çº§ (Frontend UX Upgrade)

*   **å•ä¸€ç•Œé¢é‡æ„**:
    *   **ç§»é™¤ Tabs**: åªæœ‰ "ğŸ¤– Universal Agent" ä¸€ä¸ªä¸»ç•Œé¢ã€‚
    *   **é›†æˆæ–‡ä»¶ä¸Šä¼ **: åœ¨è¾“å…¥æ¡†é™„è¿‘æˆ–ä¾§è¾¹æ æ·»åŠ  `st.file_uploader`ã€‚
    *   **ä¸Šä¼ è”åŠ¨**: æ–‡ä»¶ä¸Šä¼ åï¼Œè‡ªåŠ¨è°ƒç”¨åç«¯ API ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶å‘ Chat å‘é€ä¸€æ¡éšè—çš„/æ˜¾å¼çš„æç¤ºæ¶ˆæ¯ï¼Œå‘ŠçŸ¥ Agent æœ‰æ–°æ–‡ä»¶å¯ç”¨ã€‚
*   **é‡å†™ Chat é€»è¾‘**:
    *   ä½¿ç”¨ `st.chat_message` é…åˆ `st.write_stream` æ¶ˆè´¹åç«¯ SSE æµã€‚
    *   å¼•å…¥ `st.status` ("Thinking Container") æ¥æŠ˜å å±•ç¤º Agent çš„å·¥å…·è°ƒç”¨è¿‡ç¨‹ï¼ˆåŒ…æ‹¬ "Ingesting PDF..." çš„è¿‡ç¨‹ï¼‰ã€‚

---

## 4. å®æ–½è·¯çº¿å›¾ (Implementation Roadmap)

### Phase 1: åŸºç¡€é‡æ„ (Foundation Refactoring)
1.  **RAG é‡æ„**: ä¿®æ”¹ `langchain_qa_backend.py`ï¼Œå®ç°ç»Ÿä¸€ ChromaDB ç®¡ç†é€»è¾‘ã€‚
2.  **å·¥å…·é€šç”¨åŒ–**: ä¼˜åŒ– `search_tools.py` çš„ Promptã€‚

### Phase 2: æŒä¹…åŒ–ä¸ API (Persistence & API)
1.  **å¼•å…¥ SQLite**: é…ç½® `SqliteSaver`ã€‚
2.  **å¼€å‘æµå¼æ¥å£**: åœ¨ `main.py` ä¸­å®ç° `/chat/stream`ï¼Œæ‰“é€š `astream_events`ã€‚

### Phase 3: å‰ç«¯æµå¼å¯¹æ¥ (Frontend Streaming)
1.  **æ”¹é€  Streamlit**: æŠ›å¼ƒ `requests.post` ç­‰å¾…æ¨¡å¼ï¼Œæ”¹ç”¨ `requests.get(stream=True)` å¤„ç† SSE æµã€‚
2.  **UI ä¼˜åŒ–**: å®ç°â€œæ€ç»´é“¾æŠ˜å â€æ•ˆæœã€‚

### Phase 4: ä¼šè¯ç®¡ç† (Session Management)
1.  **åç«¯**: API æ”¯æŒ `create_session`, `get_sessions`, `delete_session`ã€‚
2.  **å‰ç«¯**: ä¾§è¾¹æ é›†æˆä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚

---

## 5. ç›®å½•ç»“æ„å˜æ›´é¢„è§ˆ

```text
My-Chat-LangChain/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ data/                   # [New] å­˜å‚¨æŒä¹…åŒ–æ•°æ®
â”‚   â”‚   â”œâ”€â”€ vector_store/       # ç»Ÿä¸€çš„ ChromaDB æ•°æ®
â”‚   â”‚   â””â”€â”€ state.db            # SQLite çŠ¶æ€æ•°æ®åº“
â”‚   â”œâ”€â”€ routers/                # [New] æ‹†åˆ† API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ chat.py             # æµå¼å¯¹è¯æ¥å£
â”‚   â”‚   â””â”€â”€ session.py          # ä¼šè¯ç®¡ç†æ¥å£
â”‚   â”œâ”€â”€ services/               # [New] ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ agent_engine.py     # Agent æ„å»ºä¸æµå¼ç”Ÿæˆå™¨
â”‚   â”‚   â””â”€â”€ rag_engine.py       # RAG ç»Ÿä¸€ç®¡ç†
â”‚   â”œâ”€â”€ ...
```
