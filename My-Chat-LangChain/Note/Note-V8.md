# Stream-Agent V8.0 å¼€å‘è¯´æ˜æ–‡æ¡£

> **ç‰ˆæœ¬**: V8.0
> **å‘å¸ƒæ—¥æœŸ**: 2025-12-17
> **æ ¸å¿ƒåŠŸèƒ½**: E2B äº‘æ²™ç®±ä»£ç æ‰§è¡Œé›†æˆ
> **æ–‡æ¡£ç±»å‹**: è¯¦ç»†å¼€å‘è¯´æ˜ä¸æŠ€æœ¯å‚è€ƒ

---

## ğŸ“‘ ç›®å½•

1. [ç‰ˆæœ¬æ¦‚è¿°](#ä¸€ç‰ˆæœ¬æ¦‚è¿°)
2. [æ–°å¢åŠŸèƒ½è¯¦è§£](#äºŒæ–°å¢åŠŸèƒ½è¯¦è§£)
3. [æŠ€æœ¯æ¶æ„](#ä¸‰æŠ€æœ¯æ¶æ„)
4. [æ–‡ä»¶å˜æ›´æ¸…å•](#å››æ–‡ä»¶å˜æ›´æ¸…å•)
5. [ä»£ç å®ç°è¯¦è§£](#äº”ä»£ç å®ç°è¯¦è§£)
6. [é…ç½®æŒ‡å—](#å…­é…ç½®æŒ‡å—)
7. [ä½¿ç”¨æ•™ç¨‹](#ä¸ƒä½¿ç”¨æ•™ç¨‹)
8. [é—®é¢˜æ’æŸ¥æŒ‡å—](#å…«é—®é¢˜æ’æŸ¥æŒ‡å—)
9. [æ€§èƒ½ä¼˜åŒ–è®°å½•](#ä¹æ€§èƒ½ä¼˜åŒ–è®°å½•)
10. [API å‚è€ƒ](#åapi-å‚è€ƒ)
11. [éƒ¨ç½²æŒ‡å—](#åä¸€éƒ¨ç½²æŒ‡å—)
12. [å¼€å‘å†ç¨‹è®°å½•](#åäºŒå¼€å‘å†ç¨‹è®°å½•)

---

## ä¸€ã€ç‰ˆæœ¬æ¦‚è¿°

### 1.1 ç‰ˆæœ¬äº®ç‚¹

Stream-Agent V8.0 æ˜¯ä¸€æ¬¡é‡å¤§åŠŸèƒ½å‡çº§ï¼Œå¼•å…¥äº† **E2B äº‘æ²™ç®±ä»£ç æ‰§è¡Œèƒ½åŠ›**ï¼Œä½¿ AI åŠ©æ‰‹èƒ½å¤Ÿï¼š

| èƒ½åŠ› | V7.0 | V8.0 |
|------|------|------|
| æ‰§è¡Œ Python ä»£ç  | âŒ | âœ… |
| æ•°æ®åˆ†æ (pandas) | âŒ | âœ… |
| ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ | âŒ | âœ… |
| ç®—æ³•éªŒè¯ä¸æµ‹è¯• | âŒ | âœ… |
| æ•°å­¦ç²¾ç¡®è®¡ç®— | âŒ | âœ… |
| æ–‡ä»¶å¤„ç†ä¸è½¬æ¢ | âŒ | âœ… |

### 1.2 ç‰ˆæœ¬å¯¹æ¯”

```
V7.0 (90+ å·¥å…·)                    V8.0 (96+ å·¥å…·)
â”œâ”€â”€ Web æœç´¢                        â”œâ”€â”€ Web æœç´¢
â”œâ”€â”€ ç”µå•†æ•°æ®æå–                     â”œâ”€â”€ ç”µå•†æ•°æ®æå–
â”œâ”€â”€ ç¤¾äº¤åª’ä½“åˆ†æ                     â”œâ”€â”€ ç¤¾äº¤åª’ä½“åˆ†æ
â”œâ”€â”€ æµè§ˆå™¨è‡ªåŠ¨åŒ–                     â”œâ”€â”€ æµè§ˆå™¨è‡ªåŠ¨åŒ–
â”œâ”€â”€ å­¦æœ¯è®ºæ–‡æœç´¢                     â”œâ”€â”€ å­¦æœ¯è®ºæ–‡æœç´¢
â”œâ”€â”€ RAG çŸ¥è¯†åº“                      â”œâ”€â”€ RAG çŸ¥è¯†åº“
â””â”€â”€ ç»“æ„åŒ–è¾“å‡º                      â”œâ”€â”€ ç»“æ„åŒ–è¾“å‡º
                                   â””â”€â”€ ğŸ†• E2B ä»£ç æ‰§è¡Œ (6ä¸ªå·¥å…·)
                                       â”œâ”€â”€ execute_python_code
                                       â”œâ”€â”€ execute_shell_command
                                       â”œâ”€â”€ install_python_package
                                       â”œâ”€â”€ upload_data_to_sandbox
                                       â”œâ”€â”€ download_file_from_sandbox
                                       â””â”€â”€ analyze_csv_data
```

### 1.3 ä¸»è¦æˆå°±

- âœ… E2B äº‘æ²™ç®±å®Œæ•´é›†æˆ
- âœ… å‰ç«¯å›¾è¡¨æ¸²æŸ“æ”¯æŒ
- âœ… å·¥å…·è°ƒç”¨æ•ˆç‡ä¼˜åŒ– (6-8æ¬¡ â†’ 3æ¬¡)
- âœ… Windows/Linux è·¨å¹³å°å…¼å®¹
- âœ… OpenAI å…¼å®¹æ¨¡å¼æ”¯æŒç¬¬ä¸‰æ–¹ LLM
- âœ… 10ä¸ªå…³é”® Bug ä¿®å¤

---

## äºŒã€æ–°å¢åŠŸèƒ½è¯¦è§£

### 2.1 E2B ä»£ç æ‰§è¡Œå·¥å…·

#### 2.1.1 execute_python_code

**åŠŸèƒ½**: åœ¨å®‰å…¨çš„äº‘æ²™ç®±ä¸­æ‰§è¡Œä»»æ„ Python ä»£ç 

**ç‰¹ç‚¹**:
- å®Œå…¨éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒ
- è‡ªåŠ¨æ•è· matplotlib å›¾è¡¨
- æ”¯æŒå¤šè¡Œä»£ç 
- 60ç§’è¶…æ—¶ä¿æŠ¤

**é¢„è£…åº“**:
```
pandas, numpy, matplotlib, seaborn, plotly, openpyxl, xlrd, scipy
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# Agent ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å·¥å…·
execute_python_code("""
import pandas as pd
import matplotlib.pyplot as plt

# åˆ›å»ºç¤ºä¾‹æ•°æ®
data = {'æœˆä»½': ['1æœˆ', '2æœˆ', '3æœˆ'], 'é”€å”®': [100, 150, 200]}
df = pd.DataFrame(data)

# ç»‘å›¾
plt.figure(figsize=(10, 6))
plt.bar(df['æœˆä»½'], df['é”€å”®'])
plt.title('æœˆåº¦é”€å”®è¶‹åŠ¿')
plt.show()  # å¿…é¡»è°ƒç”¨ plt.show() æ¥æ•è·å›¾è¡¨
""")
```

#### 2.1.2 upload_data_to_sandbox

**åŠŸèƒ½**: å°†ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ä¼ è¾“åˆ°æ²™ç®±ç¯å¢ƒ

**æ–‡ä»¶è·¯å¾„**:
- æœ¬åœ°ä¸´æ—¶ç›®å½•:
  - Windows: `backend/temp_uploads/`
  - Linux: `/tmp/temp_uploads/`
- æ²™ç®±ç›®å½•: `/home/user/data/`

**è¿”å›ä¿¡æ¯**:
```
âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ

ğŸ“ **æ–‡ä»¶ä¿¡æ¯**:
- æ–‡ä»¶å: sales.csv
- å¤§å°: 1.5 KB
- æ²™ç®±è·¯å¾„: `/home/user/data/sales.csv`

ğŸ’¡ **ä½¿ç”¨æç¤º**:
import pandas as pd
df = pd.read_csv("/home/user/data/sales.csv")
```

#### 2.1.3 analyze_csv_data

**åŠŸèƒ½**: å¿«é€Ÿåˆ†æ CSV æ–‡ä»¶ï¼Œè¿”å›æ•°æ®æ¦‚è§ˆ

**è¾“å‡ºå†…å®¹**:
- æ•°æ®ç»´åº¦ (è¡Œæ•° Ã— åˆ—æ•°)
- åˆ—ååˆ—è¡¨
- æ•°æ®ç±»å‹
- å‰5è¡Œé¢„è§ˆ
- æ•°å€¼åˆ—ç»Ÿè®¡æ‘˜è¦
- ç¼ºå¤±å€¼åˆ†æ
- åˆ†ç±»åˆ—ç»Ÿè®¡

#### 2.1.4 execute_shell_command

**åŠŸèƒ½**: åœ¨æ²™ç®±ä¸­æ‰§è¡Œ Shell å‘½ä»¤

**å®‰å…¨é™åˆ¶**:
- ç¦æ­¢å±é™©å‘½ä»¤: `rm -rf /`, `mkfs`, `dd if=`, `:(){`, `fork bomb`
- 30ç§’è¶…æ—¶

**å¸¸ç”¨åœºæ™¯**:
```bash
ls -la /home/user/data/    # æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
pip list                    # æŸ¥çœ‹å·²å®‰è£…åŒ…
cat /home/user/data/file   # æŸ¥çœ‹æ–‡ä»¶å†…å®¹
```

#### 2.1.5 install_python_package

**åŠŸèƒ½**: å®‰è£…é¢å¤–çš„ Python åŒ…

**é¢„è£…åŒ…æ£€æµ‹**: è‡ªåŠ¨è·³è¿‡å·²é¢„è£…çš„åŒ…

**è¶…æ—¶è®¾ç½®**: 120ç§’

#### 2.1.6 download_file_from_sandbox

**åŠŸèƒ½**: ä»æ²™ç®±ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶

**è¿”å›æ ¼å¼**:
- æ–‡æœ¬æ–‡ä»¶: ç›´æ¥è¿”å›å†…å®¹
- äºŒè¿›åˆ¶æ–‡ä»¶: Base64 ç¼–ç 

### 2.2 LLM é…ç½®å¢å¼º

V8.0 æ–°å¢ **OpenAI å…¼å®¹æ¨¡å¼**ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹ LLM ä¸­è½¬å¹³å°ã€‚

#### é…ç½®é€‰é¡¹

| æ¨¡å¼ | é…ç½®é¡¹ | è¯´æ˜ |
|------|--------|------|
| Google Gemini | `LLM_PROVIDER=google` | ä½¿ç”¨ Google å®˜æ–¹ API |
|  | `GOOGLE_MODEL` | æ¨¡å‹åç§°ï¼Œé»˜è®¤ `gemini-2.0-flash-lite` |
| OpenAI å…¼å®¹ | `LLM_PROVIDER=openai_compatible` | ä½¿ç”¨ç¬¬ä¸‰æ–¹ä¸­è½¬ |
|  | `OPENAI_BASE_URL` | API ç«¯ç‚¹ URL |
|  | `OPENAI_API_KEY` | API å¯†é’¥ |
|  | `OPENAI_MODEL` | æ¨¡å‹åç§° |

#### å‰ç«¯é…ç½®ç•Œé¢

```
ğŸ§  LLM Configuration
â”œâ”€â”€ â—‹ Google Gemini (Official)
â”‚   â””â”€â”€ Model Name: [gemini-2.0-flash-lite]
â””â”€â”€ â—‹ OpenAI Compatible (Proxy)
    â”œâ”€â”€ Base URL: [https://api.openai.com/v1]
    â”œâ”€â”€ API Key: [********]
    â””â”€â”€ Model Name: [gpt-4o-mini]
```

### 2.3 å‰ç«¯å›¾è¡¨æ¸²æŸ“

V8.0 å®ç°äº†å®Œæ•´çš„å›¾è¡¨æ¸²æŸ“ç®¡é“ï¼š

```
E2B æ‰§è¡Œä»£ç 
    â†“
matplotlib plt.show()
    â†“
E2B è‡ªåŠ¨æ•è· PNG
    â†“
Base64 ç¼–ç  [IMAGE_BASE64:xxx]
    â†“
åç«¯ä¿ç•™å®Œæ•´æ•°æ® (ä¸æˆªæ–­)
    â†“
å‰ç«¯è§£ç å¹¶æ¸²æŸ“ st.image()
```

**å…¼å®¹æ€§å¤„ç†**:
```python
try:
    container.image(image_bytes, use_container_width=True)
except TypeError:
    container.image(image_bytes, use_column_width=True)
```

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Stream-Agent V8.0 Architecture                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Frontend (Streamlit)                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Chat UI     â”‚ â”‚ File Upload â”‚ â”‚ LLM Config Panel        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚             â”‚ â”‚ (PDF,CSV,   â”‚ â”‚ â”œâ”€ Google Gemini        â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ - Messages  â”‚ â”‚  Excel,JSON â”‚ â”‚ â””â”€ OpenAI Compatible    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ - Charts    â”‚ â”‚  TXT,PY)    â”‚ â”‚                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ - Tools     â”‚ â”‚             â”‚ â”‚ API Keys Input          â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚ SSE Stream                            â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Backend (FastAPI)                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ /chat/streamâ”‚ â”‚/upload_file â”‚ â”‚ CORS Middleware         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ POST        â”‚ â”‚ POST        â”‚ â”‚ allow_origins=["*"]     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Agent Service (LangGraph)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚                    ReAct Agent                           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ LLM          â”‚  â”‚ Tools (96+)  â”‚  â”‚ Checkpointer â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ - Gemini     â”‚  â”‚ - MCP Tools  â”‚  â”‚ - SQLite     â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ - OpenAI     â”‚  â”‚ - Custom     â”‚  â”‚              â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   Compatible â”‚  â”‚ - E2B Tools  â”‚  â”‚              â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                       â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚          â–¼                  â–¼                  â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ MCP Servers  â”‚  â”‚ RAG System   â”‚  â”‚    E2B Cloud         â”‚      â”‚
â”‚  â”‚ - BrightData â”‚  â”‚ - ChromaDB   â”‚  â”‚    Sandbox           â”‚      â”‚
â”‚  â”‚ - PaperSearchâ”‚  â”‚ - Embeddings â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ Python Runtime â”‚  â”‚      â”‚
â”‚                                      â”‚  â”‚ - pandas       â”‚  â”‚      â”‚
â”‚                                      â”‚  â”‚ - matplotlib   â”‚  â”‚      â”‚
â”‚                                      â”‚  â”‚ - numpy        â”‚  â”‚      â”‚
â”‚                                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚                                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚
â”‚                                      â”‚  â”‚ File System    â”‚  â”‚      â”‚
â”‚                                      â”‚  â”‚ /home/user/    â”‚  â”‚      â”‚
â”‚                                      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 E2B æ²™ç®±ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2B Sandbox Lifecycle                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ç”¨æˆ·é¦–æ¬¡è¯·æ±‚ä»£ç æ‰§è¡Œ                                              â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ get_sandbox()   â”‚                                            â”‚
â”‚  â”‚ æ£€æŸ¥æ²™ç®±æ˜¯å¦å­˜åœ¨  â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                               â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚     â–¼           â–¼                                               â”‚
â”‚  ä¸å­˜åœ¨      å­˜åœ¨                                                â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚     â–¼           â–¼                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚ â”‚åˆ›å»ºæ–°æ²™ç®± â”‚  â”‚ ping æ£€æµ‹    â”‚                                  â”‚
â”‚ â”‚ timeout: â”‚  â”‚ æ‰§è¡Œç®€å•å‘½ä»¤  â”‚                                  â”‚
â”‚ â”‚ 10 min   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚                                          â”‚
â”‚      â”‚         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                    â”‚
â”‚      â–¼         â”‚           â”‚                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æˆåŠŸ        å¤±è´¥                                   â”‚
â”‚ â”‚ é¢„è£…ä¾èµ–  â”‚   â”‚           â”‚                                    â”‚
â”‚ â”‚ pandas   â”‚   â”‚           â–¼                                    â”‚
â”‚ â”‚ numpy    â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚ â”‚ matplotlibâ”‚  â”‚    â”‚ é‡å»ºæ²™ç®±  â”‚                                â”‚
â”‚ â”‚ ...      â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚         â”‚                                      â”‚
â”‚      â”‚         â”‚         â”‚                                      â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                â”‚                                                 â”‚
â”‚                â–¼                                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚         â”‚ è¿”å›æ²™ç®±  â”‚                                            â”‚
â”‚         â”‚ å®ä¾‹     â”‚                                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                â”‚                                                 â”‚
â”‚                â–¼                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚    â”‚ æ‰§è¡Œä»£ç /å‘½ä»¤         â”‚                                    â”‚
â”‚    â”‚ sandbox.run_code()    â”‚                                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                â”‚                                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚         â”‚             â”‚                                         â”‚
â”‚    æ­£å¸¸è¾“å‡º      å›¾è¡¨è¾“å‡º                                         â”‚
â”‚         â”‚             â”‚                                         â”‚
â”‚         â–¼             â–¼                                         â”‚
â”‚    stdout/       result.png                                     â”‚
â”‚    stderr        â†’ Base64                                       â”‚
â”‚         â”‚             â”‚                                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                â–¼                                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚         â”‚ è¿”å›ç»“æœ  â”‚                                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                  â”‚
â”‚  [10åˆ†é’Ÿæ— æ“ä½œåè‡ªåŠ¨é”€æ¯]                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ•°æ®æµè¯¦è§£

#### 3.3.1 å›¾è¡¨ç”Ÿæˆæ•°æ®æµ

```
ç”¨æˆ·: "ç”»ä¸€ä¸ªæ­£å¼¦æ³¢å›¾è¡¨"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent è¯†åˆ«æ„å›¾ â†’ è°ƒç”¨ execute_python_code                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ E2B æ²™ç®±æ‰§è¡Œä»£ç :                                            â”‚
â”‚ import numpy as np                                          â”‚
â”‚ import matplotlib.pyplot as plt                             â”‚
â”‚ x = np.linspace(0, 2*np.pi, 100)                           â”‚
â”‚ y = np.sin(x)                                               â”‚
â”‚ plt.plot(x, y)                                              â”‚
â”‚ plt.title('æ­£å¼¦æ³¢')                                          â”‚
â”‚ plt.show()  â† è§¦å‘å›¾è¡¨æ•è·                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ E2B è¿”å› execution.results[0].png (Base64 å­—ç¬¦ä¸²)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å…·è¿”å›:                                                    â”‚
â”‚ "ğŸ–¼ï¸ **å›¾è¡¨å·²ç”Ÿæˆå¹¶æ˜¾ç¤ºåœ¨ä¸Šæ–¹**                               â”‚
â”‚  [IMAGE_BASE64:iVBORw0KGgoAAAANSUhEUgAAA...]"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agent_service.py on_tool_end å¤„ç†:                          â”‚
â”‚ - æ£€æµ‹ [IMAGE_BASE64:...] æ ‡è®°                              â”‚
â”‚ - ä¿ç•™å®Œæ•´ Base64 æ•°æ® (ä¸æˆªæ–­)                               â”‚
â”‚ - JSON ç¼–ç å Base64 ç¼–ç æ•´ä½“æ•°æ®                             â”‚
â”‚ - SSE å‘é€: event: tool_end\ndata: {encoded}               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ app.py æ¥æ”¶:                                           â”‚
â”‚ - Base64 è§£ç è·å– JSON                                      â”‚
â”‚ - æå– tool_output                                          â”‚
â”‚ - æ­£åˆ™åŒ¹é… [IMAGE_BASE64:(...)]                             â”‚
â”‚ - base64.b64decode() è·å–å›¾ç‰‡å­—èŠ‚                            â”‚
â”‚ - st.image() æ¸²æŸ“å›¾è¡¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 CSV åˆ†ææ•°æ®æµ

```
ç”¨æˆ·ä¸Šä¼  sales.csv
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /upload_file API:                                           â”‚
â”‚ - ä¿å­˜åˆ° temp_uploads/sales.csv                             â”‚
â”‚ - è°ƒç”¨ ingest_file() åŠ å…¥ RAG çŸ¥è¯†åº“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
ç”¨æˆ·: "åˆ†æä¸Šä¼ çš„æ–‡ä»¶å¹¶ç”»é”€å”®è¶‹åŠ¿å›¾"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å…·è°ƒç”¨é“¾ (ä¼˜åŒ–åä»…3æ¬¡):                                     â”‚
â”‚                                                              â”‚
â”‚ 1. upload_data_to_sandbox("sales.csv")                      â”‚
â”‚    â†’ æ–‡ä»¶ä¼ è¾“åˆ°æ²™ç®± /home/user/data/sales.csv               â”‚
â”‚                                                              â”‚
â”‚ 2. execute_python_code(è¯»å–å¹¶æ˜¾ç¤ºåˆ—å)                       â”‚
â”‚    df = pd.read_csv(path)                                   â”‚
â”‚    print(df.columns.tolist())                               â”‚
â”‚    print(df.head())                                         â”‚
â”‚    â†’ è¾“å‡º: ['month', 'sales', 'profit']                     â”‚
â”‚                                                              â”‚
â”‚ 3. execute_python_code(æ ¹æ®å®é™…åˆ—åç”»å›¾)                     â”‚
â”‚    plt.plot(df['month'], df['sales'])                       â”‚
â”‚    plt.title('é”€å”®è¶‹åŠ¿å›¾')                                   â”‚
â”‚    plt.show()                                                â”‚
â”‚    â†’ è¿”å›å›¾è¡¨ Base64                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä»£ç è¡Œæ•° |
|---------|------|---------|
| `backend/tools/e2b_tools.py` | E2B å·¥å…·æ¨¡å— | ~500 è¡Œ |
| `backend/test_sales.csv` | æµ‹è¯•æ•°æ®æ–‡ä»¶ | 7 è¡Œ |

### 4.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | ä¸»è¦å˜æ›´ |
|---------|---------|---------|
| `backend/agent_service.py` | é‡å¤§ä¿®æ”¹ | E2Bå·¥å…·é›†æˆã€OpenAIå…¼å®¹ã€Promptä¼˜åŒ– |
| `backend/main.py` | å°ä¿®æ”¹ | Windowsè·¯å¾„å…¼å®¹ |
| `backend/requirements.txt` | æ–°å¢ä¾èµ– | e2b, e2b-code-interpreter, langchain-openai |
| `frontend/app.py` | é‡å¤§ä¿®æ”¹ | LLMé…ç½®UIã€å›¾è¡¨æ¸²æŸ“ã€Base64è¿‡æ»¤ |
| `Plan-V8.md` | æ–‡æ¡£æ›´æ–° | å¼€å‘è¿›åº¦ã€é—®é¢˜è®°å½• |

### 4.3 è¯¦ç»†å˜æ›´å†…å®¹

#### backend/agent_service.py

```diff
+ from langchain_openai import ChatOpenAI

# å·¥å…·å¯¼å…¥å˜æ›´
- from tools.e2b_tools import (
-     execute_python_code,
-     execute_shell_command,
-     install_python_package,
-     upload_data_to_sandbox,
-     download_file_from_sandbox,
-     create_visualization,
-     analyze_csv_data,
-     generate_chart_from_data,
-     close_sandbox
- )
+ from tools.e2b_tools import (
+     execute_python_code,
+     execute_shell_command,
+     install_python_package,
+     upload_data_to_sandbox,
+     download_file_from_sandbox,
+     analyze_csv_data,
+     close_sandbox
+ )

# System Prompt ä¼˜åŒ–
+ **é‡è¦æç¤º - å¿…é¡»éµå®ˆ**:
+ 1. **æ•°æ®åˆ†æ+å›¾è¡¨ä»»åŠ¡çš„æ ‡å‡†æµç¨‹(ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œ)**:
+    - ç¬¬ä¸€æ­¥: `upload_data_to_sandbox(æ–‡ä»¶å)` ä¸Šä¼ æ–‡ä»¶
+    - ç¬¬äºŒæ­¥: **å…ˆç”¨ä¸€æ®µä»£ç è¯»å–æ•°æ®å¹¶æŸ¥çœ‹åˆ—å**
+    - ç¬¬ä¸‰æ­¥: **æ ¹æ®å®é™…åˆ—å**ç¼–å†™ç”»å›¾ä»£ç 
+    - **ä¸¥ç¦çŒœæµ‹åˆ—å**ï¼å¿…é¡»å…ˆè¯»å–ç¡®è®¤

# LLM é…ç½® - æ–°å¢ OpenAI å…¼å®¹æ¨¡å¼
+ if llm_provider == "openai_compatible":
+     llm = ChatOpenAI(
+         model=openai_model,
+         base_url=openai_base_url,
+         api_key=openai_api_key,
+         temperature=0
+     )

# å·¥å…·è¾“å‡ºå¤„ç† - ä¿ç•™å®Œæ•´å›¾ç‰‡
+ if "[IMAGE_BASE64:" in output:
+     # æå–å¹¶ä¿ç•™å›¾ç‰‡æ•°æ®ï¼Œåªæˆªæ–­æ–‡æœ¬éƒ¨åˆ†
+     image_pattern = r'\[IMAGE_BASE64:[A-Za-z0-9+/=]+\]'
+     images = re.findall(image_pattern, output)
+     # ... é‡ç»„è¾“å‡ºä¿ç•™å®Œæ•´å›¾ç‰‡
```

#### backend/tools/e2b_tools.py

```diff
# æ²™ç®±è¶…æ—¶å¢åŠ åˆ°10åˆ†é’Ÿ
- timeout=300,  # 5åˆ†é’Ÿè¶…æ—¶
+ timeout=600,  # 10åˆ†é’Ÿè¶…æ—¶

# æ·»åŠ æ²™ç®±æœ‰æ•ˆæ€§æ£€æµ‹
+ try:
+     await _sandbox.run_code("print('ping')", timeout=5)
+     return _sandbox
+ except Exception as e:
+     print(f"âš ï¸ [E2B] æ²™ç®±å·²å¤±æ•ˆï¼Œæ­£åœ¨é‡æ–°åˆ›å»º...")
+     _sandbox = await _create_new_sandbox()

# Windows è·¯å¾„å…¼å®¹
+ if platform.system() == "Windows":
+     temp_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), "temp_uploads")
+ else:
+     temp_dir = "/tmp/temp_uploads"
```

#### frontend/app.py

```diff
# ç‰ˆæœ¬å·æ›´æ–°
- st.title("ğŸ¤– Stream-Agent v7.0")
+ st.title("ğŸ¤– Stream-Agent v8.0")

# æ–°å¢ LLM é…ç½®é¢æ¿
+ with st.expander("ğŸ§  LLM Configuration", expanded=True):
+     llm_provider = st.radio(
+         "Select LLM Provider",
+         options=["google", "openai_compatible"],
+         ...
+     )

# å›¾è¡¨æ¸²æŸ“å…¼å®¹æ€§
+ try:
+     container.image(image_bytes, use_container_width=True)
+ except TypeError:
+     container.image(image_bytes, use_column_width=True)

# è¿‡æ»¤æµå¼æ–‡æœ¬ä¸­çš„ Base64
+ if "[IMAGE_BASE64:" in text_content:
+     text_content = re.sub(r'\[IMAGE_BASE64:[A-Za-z0-9+/=]+\]',
+                           '[å›¾è¡¨å·²åœ¨ä¸Šæ–¹å·¥å…·ç»“æœä¸­æ˜¾ç¤º]', text_content)
```

#### backend/requirements.txt

```diff
+ langchain-openai>=0.3.0

  # E2B Code Interpreter (Cloud Sandbox)
  e2b>=1.0.0
  e2b-code-interpreter>=1.0.0
```

---

## äº”ã€ä»£ç å®ç°è¯¦è§£

### 5.1 E2B æ²™ç®±ç®¡ç†

#### å•ä¾‹æ¨¡å¼å®ç°

```python
# backend/tools/e2b_tools.py

_sandbox: Optional[AsyncSandbox] = None
_sandbox_lock: Optional[asyncio.Lock] = None

def _get_lock() -> asyncio.Lock:
    """æ‡’åŠ è½½ Lockï¼Œé¿å…æ¨¡å—åŠ è½½æ—¶äº‹ä»¶å¾ªç¯é—®é¢˜"""
    global _sandbox_lock
    if _sandbox_lock is None:
        _sandbox_lock = asyncio.Lock()
    return _sandbox_lock

async def get_sandbox() -> AsyncSandbox:
    """è·å–æˆ–åˆ›å»º E2B Sandbox å•ä¾‹"""
    global _sandbox

    async with _get_lock():
        if _sandbox is None:
            _sandbox = await _create_new_sandbox()
            return _sandbox

        # æœ‰æ•ˆæ€§æ£€æµ‹
        try:
            await _sandbox.run_code("print('ping')", timeout=5)
            return _sandbox
        except Exception:
            _sandbox = await _create_new_sandbox()
            return _sandbox
```

**è®¾è®¡è€ƒé‡**:
1. **å•ä¾‹æ¨¡å¼**: é¿å…é¢‘ç¹åˆ›å»ºæ²™ç®±ï¼ŒèŠ‚çœæ—¶é—´å’Œæˆæœ¬
2. **æ‡’åŠ è½½ Lock**: è§£å†³ `asyncio.Lock()` åœ¨æ¨¡å—åŠ è½½æ—¶çš„äº‹ä»¶å¾ªç¯é—®é¢˜
3. **æœ‰æ•ˆæ€§æ£€æµ‹**: æ²™ç®±è¶…æ—¶åè‡ªåŠ¨é‡å»º

#### æ²™ç®±åˆ›å»ºæµç¨‹

```python
async def _create_new_sandbox() -> AsyncSandbox:
    api_key = os.environ.get("E2B_API_KEY")
    if not api_key:
        raise ValueError("E2B_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®")

    sandbox = await AsyncSandbox.create(
        api_key=api_key,
        timeout=600,  # 10åˆ†é’Ÿè¶…æ—¶
    )

    # é¢„è£…ä¾èµ–
    await sandbox.run_code("""
import subprocess
subprocess.run(['pip', 'install', '-q',
    'pandas', 'numpy', 'matplotlib', 'seaborn',
    'plotly', 'openpyxl', 'xlrd', 'scipy'],
    capture_output=True)
""", timeout=120)

    return sandbox
```

### 5.2 ä»£ç æ‰§è¡Œå·¥å…·

```python
@tool
async def execute_python_code(code: str) -> str:
    """åœ¨å®‰å…¨çš„äº‘æ²™ç®±ä¸­æ‰§è¡Œ Python ä»£ç """
    sandbox = await get_sandbox()
    execution = await sandbox.run_code(code, timeout=60)

    output_parts = []

    # å¤„ç†æ ‡å‡†è¾“å‡º
    if execution.logs and execution.logs.stdout:
        stdout_content = '\n'.join(execution.logs.stdout)
        output_parts.append(f"ğŸ“¤ **è¾“å‡º**:\n```\n{stdout_content}\n```")

    # å¤„ç†å›¾ç‰‡ç»“æœ
    if execution.results:
        for result in execution.results:
            if hasattr(result, 'png') and result.png:
                output_parts.append(
                    f"ğŸ–¼ï¸ **å›¾è¡¨å·²ç”Ÿæˆå¹¶æ˜¾ç¤ºåœ¨ä¸Šæ–¹**\n[IMAGE_BASE64:{result.png}]"
                )

    # å¤„ç†é”™è¯¯
    if execution.error:
        output_parts.append(f"âŒ **æ‰§è¡Œé”™è¯¯**:\n{execution.error}")

    return "\n\n".join(output_parts)
```

**å…³é”®ç‚¹**:
1. **E2B Code Interpreter API**: ä½¿ç”¨ `run_code()` è€Œé `commands.run()`
2. **å›¾è¡¨è‡ªåŠ¨æ•è·**: `plt.show()` åå›¾ç‰‡åœ¨ `execution.results[0].png`
3. **é”™è¯¯å¤„ç†**: å®Œæ•´æ•è·å¹¶æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯

### 5.3 å›¾è¡¨æ¸²æŸ“ç®¡é“

#### åç«¯å¤„ç† (agent_service.py)

```python
elif kind == "on_tool_end":
    output = str(event["data"].get("output", ""))

    # æ£€æµ‹å›¾ç‰‡æ•°æ®
    if "[IMAGE_BASE64:" in output:
        image_pattern = r'\[IMAGE_BASE64:[A-Za-z0-9+/=]+\]'
        images = re.findall(image_pattern, output)
        text_parts = re.split(image_pattern, output)

        # åªæˆªæ–­æ–‡æœ¬ï¼Œä¿ç•™å®Œæ•´å›¾ç‰‡
        truncated_text_parts = [
            (part[:500] + '...' if len(part) > 500 else part)
            for part in text_parts
        ]

        # é‡ç»„è¾“å‡º
        safe_output = ""
        for i, text_part in enumerate(truncated_text_parts):
            safe_output += text_part
            if i < len(images):
                safe_output += images[i]
    else:
        safe_output = (output[:1000] + '...') if len(output) > 1000 else output
```

#### å‰ç«¯æ¸²æŸ“ (app.py)

```python
def render_tool_output(output_str, container):
    image_pattern = r'\[IMAGE_BASE64:([A-Za-z0-9+/=]+)\]'
    matches = list(re.finditer(image_pattern, output_str))

    if matches:
        for match in matches:
            image_b64 = match.group(1)
            image_bytes = base64.b64decode(image_b64)

            # Streamlit ç‰ˆæœ¬å…¼å®¹
            try:
                container.image(image_bytes, caption="ğŸ“Š Generated Chart",
                              use_container_width=True)
            except TypeError:
                container.image(image_bytes, caption="ğŸ“Š Generated Chart",
                              use_column_width=True)
```

### 5.4 LLM é…ç½®åˆ‡æ¢

```python
# backend/agent_service.py

llm_provider = api_keys.get("LLM_PROVIDER", "google")

if llm_provider == "openai_compatible":
    llm = ChatOpenAI(
        model=api_keys.get("OPENAI_MODEL", "gpt-4o-mini"),
        base_url=api_keys.get("OPENAI_BASE_URL"),
        api_key=api_keys.get("OPENAI_API_KEY"),
        temperature=0
    )
else:
    llm = ChatGoogleGenerativeAI(
        model=api_keys.get("GOOGLE_MODEL", "gemini-2.0-flash-lite"),
        google_api_key=os.environ["GOOGLE_API_KEY"],
        temperature=0
    )
```

---

## å…­ã€é…ç½®æŒ‡å—

### 6.1 ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `backend/.env` æ–‡ä»¶ï¼š

```bash
# ============================================================
# LLM é…ç½® (äºŒé€‰ä¸€)
# ============================================================

# æ–¹å¼1: Google Gemini (é»˜è®¤)
GOOGLE_API_KEY=your_google_api_key
GOOGLE_MODEL=gemini-2.0-flash-lite

# æ–¹å¼2: OpenAI å…¼å®¹æ¨¡å¼ (å¯é€‰)
# LLM_PROVIDER=openai_compatible
# OPENAI_BASE_URL=https://api.openrouter.ai/api/v1
# OPENAI_API_KEY=your_api_key
# OPENAI_MODEL=google/gemini-2.0-flash-exp:free

# ============================================================
# MCP å·¥å…· API Keys
# ============================================================

BRIGHT_DATA_API_KEY=your_bright_data_key
PAPER_SEARCH_API_KEY=your_paper_search_key

# ============================================================
# E2B ä»£ç æ‰§è¡Œ (å¿…é¡»)
# ============================================================

E2B_API_KEY=your_e2b_api_key
```

### 6.2 è·å– API Key

| æœåŠ¡ | è·å–åœ°å€ | å…è´¹é¢åº¦ |
|------|---------|---------|
| E2B | https://e2b.dev/dashboard | Hobby è®¡åˆ’å…è´¹ |
| Google AI | https://aistudio.google.com/apikey | å…è´¹ |
| BrightData | https://brightdata.com | è¯•ç”¨ |
| Paper Search | Smithery.ai | å…è´¹ |

### 6.3 å‰ç«¯é…ç½®

åœ¨ Streamlit ä¾§è¾¹æ å¯åŠ¨æ€é…ç½®ï¼š

1. **LLM Configuration**: é€‰æ‹© Google æˆ– OpenAI Compatible
2. **Tool API Keys**: è¾“å…¥å„å·¥å…·çš„ API Key
3. **File Upload**: ä¸Šä¼ æ•°æ®æ–‡ä»¶

---

## ä¸ƒã€ä½¿ç”¨æ•™ç¨‹

### 7.1 åŸºç¡€ä»£ç æ‰§è¡Œ

**ç”¨æˆ·è¾“å…¥**:
```
å¸®æˆ‘è®¡ç®— 1 åˆ° 100 çš„å’Œ
```

**Agent æ‰§è¡Œ**:
```python
execute_python_code("""
total = sum(range(1, 101))
print(f"1 åˆ° 100 çš„å’Œæ˜¯: {total}")
""")
```

**è¾“å‡º**:
```
ğŸ“¤ è¾“å‡º:
1 åˆ° 100 çš„å’Œæ˜¯: 5050

âœ… ä»£ç æ‰§è¡ŒæˆåŠŸ
```

### 7.2 æ•°å­¦å›¾è¡¨ç”Ÿæˆ

**ç”¨æˆ·è¾“å…¥**:
```
ç”»ä¸€ä¸ªæ­£å¼¦æ³¢å’Œä½™å¼¦æ³¢çš„å¯¹æ¯”å›¾
```

**Agent æ‰§è¡Œ**:
```python
execute_python_code("""
import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(0, 2*np.pi, 100)

plt.figure(figsize=(10, 6))
plt.plot(x, np.sin(x), label='sin(x)', color='blue')
plt.plot(x, np.cos(x), label='cos(x)', color='red')
plt.title('æ­£å¼¦æ³¢ä¸ä½™å¼¦æ³¢å¯¹æ¯”')
plt.xlabel('x')
plt.ylabel('y')
plt.legend()
plt.grid(True)
plt.show()
""")
```

**è¾“å‡º**: æ˜¾ç¤ºå¯¹æ¯”å›¾è¡¨

### 7.3 CSV æ•°æ®åˆ†æ

**æ­¥éª¤ 1**: ä¸Šä¼  CSV æ–‡ä»¶ (é€šè¿‡ä¾§è¾¹æ )

**æ­¥éª¤ 2**: å‘é€æ¶ˆæ¯
```
åˆ†æä¸Šä¼ çš„ sales.csv æ–‡ä»¶ï¼Œæ‰¾å‡ºé”€å”®æœ€å¥½çš„æœˆä»½ï¼Œå¹¶ç”»ä¸€ä¸ªè¶‹åŠ¿å›¾
```

**Agent æ‰§è¡Œæµç¨‹**:
```
1. upload_data_to_sandbox("sales.csv")
   â†’ æ–‡ä»¶ä¸Šä¼ åˆ°æ²™ç®±

2. execute_python_code(è¯»å–åˆ—å)
   â†’ è¾“å‡º: ['month', 'sales', 'profit']

3. execute_python_code(åˆ†æå¹¶ç”»å›¾)
   â†’ è¾“å‡ºåˆ†æç»“æœ + è¶‹åŠ¿å›¾
```

### 7.4 ç®—æ³•éªŒè¯

**ç”¨æˆ·è¾“å…¥**:
```
å†™ä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•å¹¶ç”¨æµ‹è¯•ç”¨ä¾‹éªŒè¯
```

**Agent æ‰§è¡Œ**:
```python
execute_python_code("""
def quicksort(arr):
    if len(arr) <= 1:
        return arr
    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]
    return quicksort(left) + middle + quicksort(right)

# æµ‹è¯•ç”¨ä¾‹
test_cases = [
    [3, 6, 8, 10, 1, 2, 1],
    [],
    [1],
    [5, 4, 3, 2, 1],
    [1, 2, 3, 4, 5],
]

print("å¿«é€Ÿæ’åºæµ‹è¯•ç»“æœ:")
for i, arr in enumerate(test_cases):
    result = quicksort(arr.copy())
    expected = sorted(arr)
    status = "âœ…" if result == expected else "âŒ"
    print(f"{status} æµ‹è¯• {i+1}: {arr} â†’ {result}")
""")
```

### 7.5 å®‰è£…é¢å¤–åŒ…

**ç”¨æˆ·è¾“å…¥**:
```
å¸®æˆ‘å®‰è£… requests åº“å¹¶æµ‹è¯• HTTP è¯·æ±‚
```

**Agent æ‰§è¡Œ**:
```
1. install_python_package("requests")
   â†’ âœ… æˆåŠŸå®‰è£… requests

2. execute_python_code("""
   import requests
   response = requests.get('https://httpbin.org/get')
   print(f"çŠ¶æ€ç : {response.status_code}")
   print(f"å“åº”: {response.json()}")
   """)
```

---

## å…«ã€é—®é¢˜æ’æŸ¥æŒ‡å—

### 8.1 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯ 1: E2B_API_KEY æœªè®¾ç½®

**é”™è¯¯ä¿¡æ¯**:
```
ValueError: E2B_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®ã€‚è¯·åœ¨ .env æ–‡ä»¶ä¸­é…ç½® E2B_API_KEYã€‚
```

**è§£å†³æ–¹æ¡ˆ**:
1. è®¿é—® https://e2b.dev/dashboard è·å– API Key
2. åœ¨ `backend/.env` æ·»åŠ  `E2B_API_KEY=your_key`
3. æˆ–åœ¨å‰ç«¯ä¾§è¾¹æ è¾“å…¥ API Key

#### é”™è¯¯ 2: æ²™ç®±è¶…æ—¶ 502 é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
The sandbox was not found, code: 502
```

**åŸå› **: æ²™ç®±è¶…æ—¶è¢«è‡ªåŠ¨é”€æ¯

**è§£å†³æ–¹æ¡ˆ**: V8.0 å·²è‡ªåŠ¨å¤„ç†ï¼Œæ²™ç®±ä¼šè‡ªåŠ¨é‡å»º

#### é”™è¯¯ 3: å›¾è¡¨ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
1. ä»£ç ä¸­æ²¡æœ‰ `plt.show()`
2. Base64 æ•°æ®è¢«æˆªæ–­
3. å‰ç«¯æ¸²æŸ“é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
1. ç¡®è®¤ä»£ç ä»¥ `plt.show()` ç»“å°¾
2. æ£€æŸ¥åç«¯æ—¥å¿—ä¸­ `[IMAGE_BASE64:` æ˜¯å¦å®Œæ•´
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

#### é”™è¯¯ 4: æ–‡ä»¶ä¸Šä¼ åæ‰¾ä¸åˆ°

**é”™è¯¯ä¿¡æ¯**:
```
âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: data.csvã€‚ä¸´æ—¶ä¸Šä¼ ç›®å½•ä¸ºç©ºï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤æ–‡ä»¶å·²é€šè¿‡å‰ç«¯ä¸Šä¼ 
2. æ£€æŸ¥ `temp_uploads/` ç›®å½•æ˜¯å¦å­˜åœ¨æ–‡ä»¶
3. ä½¿ç”¨å‡†ç¡®çš„æ–‡ä»¶å (åŒºåˆ†å¤§å°å†™)

#### é”™è¯¯ 5: Streamlit expander åµŒå¥—é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
StreamlitAPIException: Expanders may not be nested inside other expanders.
```

**åŸå› **: `st.status()` å†…éƒ¨ä¸èƒ½ä½¿ç”¨ `st.expander()`

**è§£å†³æ–¹æ¡ˆ**: V8.0 å·²ä¿®å¤ï¼Œç›´æ¥åœ¨ status_container ä¸­æ¸²æŸ“

### 8.2 è°ƒè¯•æŠ€å·§

#### æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# å¯åŠ¨åç«¯æ—¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
cd backend
python -m uvicorn main:app --reload --log-level debug
```

#### æ£€æŸ¥æ²™ç®±çŠ¶æ€

åœ¨å‰ç«¯å‘é€:
```
å¸®æˆ‘æ‰§è¡Œ: import sys; print(sys.version); import pandas; print(pandas.__version__)
```

#### æŸ¥çœ‹å¯ç”¨æ–‡ä»¶

```
å¸®æˆ‘æ‰§è¡Œ Shell å‘½ä»¤: ls -la /home/user/data/
```

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–è®°å½•

### 9.1 å·¥å…·è°ƒç”¨ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|--------|--------|--------|------|
| CSVåˆ†æ+ç”»å›¾ | 6-8æ¬¡å·¥å…·è°ƒç”¨ | 3æ¬¡ | å‡å°‘ 50%+ |
| æ•°å­¦å›¾è¡¨ | 3-4æ¬¡ | 1-2æ¬¡ | å‡å°‘ 50% |
| åˆ—åçŒœæµ‹é”™è¯¯ | é¢‘ç¹ | å‡ ä¹æ—  | æ˜¾è‘—æ”¹å–„ |

### 9.2 ä¼˜åŒ–æªæ–½

1. **ç®€åŒ–å·¥å…·é›†**: ä» 8 ä¸ªå·¥å…·å‡å°‘åˆ° 6 ä¸ª
   - ç§»é™¤ `create_visualization`
   - ç§»é™¤ `generate_chart_from_data`
   - ç»Ÿä¸€ä½¿ç”¨ `execute_python_code`

2. **ä¼˜åŒ– System Prompt**:
   ```
   **ä¸¥ç¦çŒœæµ‹åˆ—å**ï¼å¿…é¡»å…ˆè¯»å–ç¡®è®¤
   ç¬¬ä¸€æ­¥: upload_data_to_sandbox
   ç¬¬äºŒæ­¥: è¯»å–åˆ—å
   ç¬¬ä¸‰æ­¥: æ ¹æ®å®é™…åˆ—åç”»å›¾
   ```

3. **æ²™ç®±å¤ç”¨**: å•ä¾‹æ¨¡å¼é¿å…é‡å¤åˆ›å»º

### 9.3 æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | è€—æ—¶ |
|------|------|
| é¦–æ¬¡åˆ›å»ºæ²™ç®± | 3-5ç§’ |
| é¢„è£…ä¾èµ– | 30-60ç§’ (ä»…é¦–æ¬¡) |
| ç®€å•ä»£ç æ‰§è¡Œ | 1-2ç§’ |
| æ•°æ®åˆ†æ | 2-5ç§’ |
| å›¾è¡¨ç”Ÿæˆ | 3-8ç§’ |
| æ²™ç®± ping æ£€æµ‹ | <1ç§’ |

---

## åã€API å‚è€ƒ

### 10.1 åç«¯ API

#### POST /chat/stream

æµå¼èŠå¤©æ¥å£ï¼Œè¿”å› SSE äº‹ä»¶æµã€‚

**è¯·æ±‚ä½“**:
```json
{
  "message": "ç”¨æˆ·æ¶ˆæ¯",
  "thread_id": "ä¼šè¯ID",
  "api_keys": {
    "LLM_PROVIDER": "google",
    "GOOGLE_MODEL": "gemini-2.0-flash-lite",
    "E2B_API_KEY": "xxx",
    "BRIGHT_DATA_API_KEY": "xxx"
  }
}
```

**SSE äº‹ä»¶ç±»å‹**:
| äº‹ä»¶ | æ•°æ®æ ¼å¼ | è¯´æ˜ |
|------|---------|------|
| `text` | Base64 ç¼–ç æ–‡æœ¬ | AI å›å¤å†…å®¹ |
| `tool_start` | Base64 ç¼–ç å·¥å…·å | å·¥å…·å¼€å§‹æ‰§è¡Œ |
| `tool_end` | Base64 ç¼–ç  JSON | å·¥å…·æ‰§è¡Œç»“æœ |
| `done` | "complete" | æµç»“æŸ |

#### POST /upload_file

ä¸Šä¼ æ–‡ä»¶æ¥å£ã€‚

**è¯·æ±‚**: multipart/form-data
**å“åº”**:
```json
{
  "filename": "data.csv",
  "message": "File data.csv uploaded and learned successfully!"
}
```

### 10.2 E2B å·¥å…· API

#### execute_python_code(code: str) -> str

æ‰§è¡Œ Python ä»£ç ã€‚

**å‚æ•°**:
- `code`: Python ä»£ç å­—ç¬¦ä¸²

**è¿”å›**: æ‰§è¡Œç»“æœï¼Œå¯èƒ½åŒ…å« `[IMAGE_BASE64:xxx]` å›¾ç‰‡æ ‡è®°

#### upload_data_to_sandbox(filename: str) -> str

ä¸Šä¼ æ–‡ä»¶åˆ°æ²™ç®±ã€‚

**å‚æ•°**:
- `filename`: æœ¬åœ°ä¸´æ—¶ç›®å½•ä¸­çš„æ–‡ä»¶å

**è¿”å›**: ä¸Šä¼ ç»“æœå’Œæ²™ç®±è·¯å¾„

#### analyze_csv_data(filename: str, analysis_request: str) -> str

åˆ†æ CSV æ–‡ä»¶ã€‚

**å‚æ•°**:
- `filename`: æ–‡ä»¶è·¯å¾„æˆ–æ–‡ä»¶å
- `analysis_request`: åˆ†æéœ€æ±‚æè¿°

**è¿”å›**: æ•°æ®æ¦‚è§ˆå’Œç»Ÿè®¡ä¿¡æ¯

#### execute_shell_command(command: str) -> str

æ‰§è¡Œ Shell å‘½ä»¤ã€‚

**å‚æ•°**:
- `command`: Shell å‘½ä»¤

**è¿”å›**: å‘½ä»¤è¾“å‡º

#### install_python_package(package_name: str) -> str

å®‰è£… Python åŒ…ã€‚

**å‚æ•°**:
- `package_name`: åŒ…åï¼Œæ”¯æŒç‰ˆæœ¬æŒ‡å®š

**è¿”å›**: å®‰è£…ç»“æœ

#### download_file_from_sandbox(sandbox_path: str) -> str

ä¸‹è½½æ²™ç®±æ–‡ä»¶ã€‚

**å‚æ•°**:
- `sandbox_path`: æ²™ç®±ä¸­çš„æ–‡ä»¶è·¯å¾„

**è¿”å›**: æ–‡ä»¶å†…å®¹æˆ– Base64 ç¼–ç 

---

## åä¸€ã€éƒ¨ç½²æŒ‡å—

### 11.1 æœ¬åœ°å¼€å‘

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repo_url>
cd My-Chat-LangChain

# 2. å®‰è£…åç«¯ä¾èµ–
cd backend
pip install -r requirements.txt

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥ API Keys

# 4. å¯åŠ¨åç«¯
uvicorn main:app --reload --port 8000

# 5. å¯åŠ¨å‰ç«¯ (æ–°ç»ˆç«¯)
cd ../frontend
streamlit run app.py --server.port 8501
```

### 11.2 Render éƒ¨ç½² (æ¨è)

æœ¬é¡¹ç›®ä½¿ç”¨ **Docker + Blueprint** æ–¹å¼éƒ¨ç½²åˆ° Renderï¼Œå‰åç«¯è¿è¡Œåœ¨åŒä¸€å®¹å™¨ä¸­ã€‚

#### æ ¸å¿ƒé…ç½®æ–‡ä»¶

**render.yaml** (ä½äºé¡¹ç›®æ ¹ç›®å½•):
```yaml
# ============================================================
# Render Blueprint é…ç½®æ–‡ä»¶ - Stream-Agent V8.0
# ============================================================

services:
  - type: web
    name: my-chat-langchain
    runtime: docker
    plan: free
    rootDir: My-Chat-LangChain

    # å¥åº·æ£€æŸ¥é…ç½®
    healthCheckPath: /health

    # ç¯å¢ƒå˜é‡é…ç½®
    envVars:
      # LLM é…ç½® (Google Gemini)
      - key: GOOGLE_API_KEY
        sync: false  # åœ¨ Render Dashboard æ‰‹åŠ¨å¡«å…¥
      - key: GOOGLE_MODEL
        value: gemini-2.0-flash-lite

      # E2B ä»£ç æ‰§è¡Œ (V8.0 å¿…é¡»)
      - key: E2B_API_KEY
        sync: false

      # MCP å·¥å…· (å¯é€‰)
      - key: BRIGHT_DATA_API_KEY
        sync: false
      - key: PAPER_SEARCH_API_KEY
        sync: false

      # ç³»ç»Ÿé…ç½®
      - key: DATA_DIR
        value: /var/lib/data
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONPATH
        value: /app/backend
```

**Dockerfile**:
```dockerfile
FROM python:3.11-slim
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app/backend
ENV DATA_DIR=/var/lib/data

# å¯åŠ¨è„šæœ¬
RUN chmod +x start.sh
EXPOSE 8501
CMD ["./start.sh"]
```

**start.sh**:
```bash
#!/bin/bash
set -e

# å¯åŠ¨åç«¯
uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
sleep 5

# å¯åŠ¨å‰ç«¯
export BACKEND_URL="http://127.0.0.1:8000"
PORT=${PORT:-8501}
streamlit run frontend/app.py \
    --server.port=$PORT \
    --server.address=0.0.0.0 \
    --server.enableCORS=false
```

#### éƒ¨ç½²æ­¥éª¤

1. **å‡†å¤‡ API Keys**:
   - `GOOGLE_API_KEY`: https://aistudio.google.com/apikey
   - `E2B_API_KEY`: https://e2b.dev/dashboard

2. **åˆ›å»º Blueprint**:
   - Render Dashboard â†’ New + â†’ Blueprint
   - è¿æ¥ GitHub ä»“åº“
   - è‡ªåŠ¨è¯»å– `render.yaml`

3. **é…ç½®ç¯å¢ƒå˜é‡**:
   - Environment â†’ æ·»åŠ  `GOOGLE_API_KEY`
   - Environment â†’ æ·»åŠ  `E2B_API_KEY`

4. **éƒ¨ç½²éªŒè¯**:
   - æŸ¥çœ‹ Logs ç¡®è®¤å¯åŠ¨æˆåŠŸ
   - è®¿é—® URL æµ‹è¯•åŠŸèƒ½
   - å‘é€ "ç”»ä¸€ä¸ªæ­£å¼¦æ³¢" éªŒè¯ E2B

#### éƒ¨ç½²æ ¸å¯¹æ¸…å•

- [ ] `requirements.txt` åŒ…å« E2B ä¾èµ–
- [ ] `render.yaml` é…ç½®æ­£ç¡®
- [ ] `GOOGLE_API_KEY` å·²è®¾ç½®
- [ ] `E2B_API_KEY` å·²è®¾ç½®
- [ ] æ—¥å¿—æ˜¾ç¤º "Application startup complete"
- [ ] å›¾è¡¨åŠŸèƒ½æ­£å¸¸

è¯¦ç»†éƒ¨ç½²æŒ‡å—è¯·å‚è€ƒ: [Deployment-Guide.md](Deployment-Guide.md)

### 11.3 ç¯å¢ƒå˜é‡æ¸…å•

| å˜é‡å | å¿…é¡» | è¯´æ˜ |
|--------|------|------|
| `GOOGLE_API_KEY` | æ˜¯* | Google AI API Key |
| `GOOGLE_MODEL` | å¦ | æ¨¡å‹åç§°ï¼Œé»˜è®¤ gemini-2.0-flash-lite |
| `E2B_API_KEY` | æ˜¯ | E2B æ²™ç®± API Key |
| `BRIGHT_DATA_API_KEY` | å¦ | BrightData MCP Key |
| `PAPER_SEARCH_API_KEY` | å¦ | Paper Search MCP Key |
| `LLM_PROVIDER` | å¦ | é»˜è®¤ "google"ï¼Œå¯é€‰ "openai_compatible" |
| `OPENAI_BASE_URL` | å¦ | OpenAI å…¼å®¹æ¨¡å¼ URL |
| `OPENAI_API_KEY` | å¦ | OpenAI å…¼å®¹æ¨¡å¼ Key |
| `OPENAI_MODEL` | å¦ | OpenAI å…¼å®¹æ¨¡å¼æ¨¡å‹ |
| `DATA_DIR` | å¦ | æ•°æ®ç›®å½•ï¼Œé»˜è®¤ /var/lib/data |
| `PYTHONPATH` | å¦ | Python è·¯å¾„ï¼Œé»˜è®¤ /app/backend |

*å¦‚æœä½¿ç”¨ OpenAI å…¼å®¹æ¨¡å¼ï¼Œå¯ä»¥ä¸è®¾ç½®

---

## åäºŒã€å¼€å‘å†ç¨‹è®°å½•

### 12.1 æ—¶é—´çº¿

| æ—¶é—´ | äº‹ä»¶ |
|------|------|
| 2025-12-17 ä¸Šåˆ | å¼€å§‹ E2B é›†æˆå¼€å‘ |
| 2025-12-17 ä¸Šåˆ | å®ŒæˆåŸºç¡€å·¥å…·å®ç° |
| 2025-12-17 ä¸‹åˆ | é‡åˆ°å¹¶è§£å†³ SSE ä»£ç†é—®é¢˜ |
| 2025-12-17 ä¸‹åˆ | ä¿®å¤ E2B API å…¼å®¹æ€§é—®é¢˜ |
| 2025-12-17 ä¸‹åˆ | ä¿®å¤å›¾è¡¨ä¸æ˜¾ç¤ºé—®é¢˜ |
| 2025-12-17 ä¸‹åˆ | ä¿®å¤ Streamlit åµŒå¥—é”™è¯¯ |
| 2025-12-17 ä¸‹åˆ | ä¿®å¤æ²™ç®±è¶…æ—¶é—®é¢˜ |
| 2025-12-17 ä¸‹åˆ | ä¼˜åŒ–å·¥å…·è°ƒç”¨æ•ˆç‡ |
| 2025-12-17 æ™šä¸Š | å®Œæˆæ‰€æœ‰æµ‹è¯•ï¼ŒV8.0 å‘å¸ƒ |

### 12.2 è§£å†³çš„æŠ€æœ¯é—®é¢˜

| # | é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---|------|------|----------|
| 1 | å‰ç«¯å¡åœ¨ "Thinking..." | ä»£ç†èŠ‚ç‚¹é—®é¢˜ | åˆ‡æ¢èŠ‚ç‚¹ |
| 2 | `'str' object has no attribute 'line'` | E2B API å˜æ›´ | ä¿®æ”¹ stdout å¤„ç† |
| 3 | `asyncio.Lock()` é”™è¯¯ | æ¨¡å—åŠ è½½æ—¶åˆ›å»º | æ‡’åŠ è½½ |
| 4 | å›¾è¡¨ä¸æ˜¾ç¤º | Base64 è¢«æˆªæ–­ | ä¿ç•™å®Œæ•´æ•°æ® |
| 5 | expander åµŒå¥—é”™è¯¯ | Streamlit é™åˆ¶ | ç›´æ¥æ¸²æŸ“ |
| 6 | use_container_width é”™è¯¯ | ç‰ˆæœ¬å·®å¼‚ | try/except |
| 7 | æ²™ç®± 502 é”™è¯¯ | è¶…æ—¶å¤±æ•ˆ | è‡ªåŠ¨é‡å»º |
| 8 | æ–‡ä»¶è·¯å¾„é”™è¯¯ | Windows è·¯å¾„ | platform åˆ¤æ–­ |
| 9 | LLM è¾“å‡º Base64 | å¤è¿°å·¥å…·è¾“å‡º | è¿‡æ»¤ + Prompt |
| 10 | å·¥å…·è°ƒç”¨æ··ä¹± | å·¥å…·è¿‡å¤š | ç®€åŒ– + Prompt |

### 12.3 ç»éªŒæ•™è®­

1. **E2B SDK ç‰ˆæœ¬**: ä½¿ç”¨ `>=1.0.0` è€Œéå›ºå®šç‰ˆæœ¬
2. **å¼‚æ­¥é”**: ä¸è¦åœ¨æ¨¡å—çº§åˆ«åˆ›å»º `asyncio.Lock()`
3. **å›¾ç‰‡ä¼ è¾“**: Base64 æ•°æ®å¿…é¡»å®Œæ•´ä¿ç•™
4. **Streamlit å…¼å®¹**: ä½¿ç”¨ try/except å¤„ç† API å·®å¼‚
5. **å·¥å…·è®¾è®¡**: è¶Šå°‘è¶Šå¥½ï¼Œå‡å°‘ LLM é€‰æ‹©å›°éš¾
6. **Prompt å·¥ç¨‹**: æ˜ç¡®çš„æµç¨‹æŒ‡å¯¼æ¯”å¤šä¸ªå·¥å…·æ›´æœ‰æ•ˆ

---

## é™„å½•

### A. æµ‹è¯•æ•°æ®æ–‡ä»¶

`backend/test_sales.csv`:
```csv
month,sales,profit
January,1000,200
February,1200,250
March,1500,300
April,1300,280
May,1800,400
June,2000,450
```

### B. ç›¸å…³æ–‡æ¡£

- [Plan-V8.md](./Plan-V8.md) - å¼€å‘è®¡åˆ’æ–‡æ¡£
- [README.md](./README.md) - é¡¹ç›®è¯´æ˜
- [E2B å®˜æ–¹æ–‡æ¡£](https://e2b.dev/docs)
- [LangChain æ–‡æ¡£](https://python.langchain.com/)

### C. è”ç³»ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– PRã€‚

---

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2025-12-17
> **ä½œè€…**: Claude Code Assistant
